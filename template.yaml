AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: CloudOps Cost & Reliability Guardrails (V1) - Production-ready secure scaffold (V1-Simple)

Globals:
  Function:
    Runtime: python3.12
    Timeout: 30
    MemorySize: 256
    Tracing: Active

Parameters:
  AdminEmail:
    Type: String
    Description: Email address for initial admin user (V1). Used for optional billing alarm notifications.

  MonitoredApiGatewayId:
    Type: String
    Description: API Gateway identifier to monitor (V1)

  DemoMode:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]

  DbName:
    Type: String
    Default: cloudops

  DbInstanceClass:
    Type: String
    Default: db.t4g.micro

  DbAllocatedStorage:
    Type: Number
    Default: 20

  EnableBillingAlarm:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]
    Description: Create an EstimatedCharges billing alarm (works in us-east-1; billing alerts must be enabled in the account)

  BillingAlarmThreshold:
    Type: Number
    Default: 60
    Description: Monthly estimated charges threshold in USD

Conditions:
  CreateBillingAlarm: !Equals [!Ref EnableBillingAlarm, "true"]
  IsUsEast1: !Equals [!Ref "AWS::Region", "us-east-1"]
  CreateBillingAlarmInRegion:
    !And [!Condition CreateBillingAlarm, !Condition IsUsEast1]

Resources:
  ############################################################
  # Networking (2 AZ, public + private, single NAT)
  ############################################################
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.20.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-vpc"

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-igw"

  VpcGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref Vpc
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-rt"

  PublicDefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: VpcGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: 10.20.0.0/20
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-a"

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: 10.20.16.0/20
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-b"

  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  NatEip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nat-eip"

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEip.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-nat"

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-rt"

  PrivateDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: 10.20.32.0/20
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-a"

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: 10.20.48.0/20
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-b"

  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTable

  ############################################################
  # VPC Endpoint (S3 Gateway)
  ############################################################
  S3GatewayEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref Vpc
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable

    ###########################################################
  # Security Groups (Lambda, DB) â€” break circular dependency
  ###########################################################
  DbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: CloudOps Guardrails Postgres SG
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-db-sg"

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: CloudOps Guardrails Lambda SG
      VpcId: !Ref Vpc
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow outbound (NAT + AWS APIs). DB restricted by DB SG ingress.
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-lambda-sg"

  DbIngressFromLambda:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref DbSecurityGroup
      IpProtocol: tcp
      FromPort: 5432
      ToPort: 5432
      SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Description: Allow Lambda to reach RDS

  ############################################################
  # Frontend (S3 private + CloudFront OAC)
  ############################################################
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-frontend"

  CloudFrontOac:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "${AWS::StackName}-oac"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          - Id: FrontendOrigin
            DomainName: !GetAtt FrontendBucket.RegionalDomainName
            S3OriginConfig: {}
            OriginAccessControlId: !Ref CloudFrontOac
        DefaultCacheBehavior:
          TargetOriginId: FrontendOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: [GET, HEAD, OPTIONS]
          CachedMethods: [GET, HEAD, OPTIONS]
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
        Comment: !Sub "${AWS::StackName} frontend distribution"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-cloudfront"

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontRead
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub "${FrontendBucket.Arn}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"

  ############################################################
  # Auth (Cognito Hosted UI, optional MFA)
  ############################################################
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "${AWS::StackName}-user-pool"
      UsernameAttributes: [email]
      AutoVerifiedAttributes: [email]
      MfaConfiguration: OPTIONAL
      EnabledMfas:
        - SOFTWARE_TOKEN_MFA
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireUppercase: true
          RequireNumbers: true
          RequireSymbols: false
      UserPoolTags:
        Name: !Sub "${AWS::StackName}-user-pool"

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "${AWS::StackName}-client"
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      SupportedIdentityProviders: [COGNITO]
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows: [code]
      AllowedOAuthScopes: [openid, email, profile]
      CallbackURLs:
        - !Sub "https://${CloudFrontDistribution.DomainName}/callback"
      LogoutURLs:
        - !Sub "https://${CloudFrontDistribution.DomainName}/logout"

  UserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub "${AWS::StackName}-${AWS::AccountId}"
      UserPoolId: !Ref UserPool

  ############################################################
  # API Gateway (Cognito Authorizer default + throttling)
  ############################################################
  RestApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      EndpointConfiguration: REGIONAL
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          ThrottlingBurstLimit: 200
          ThrottlingRateLimit: 100
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt UserPool.Arn
      Tags:
        Name: !Sub "${AWS::StackName}-api"

  ############################################################
  # Database (RDS Postgres in private subnets)
  ############################################################
  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: CloudOps Guardrails DB subnet group
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-db-subnet-group"

  DbSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${AWS::StackName}-db-credentials"
      Description: RDS PostgreSQL master credentials
      GenerateSecretString:
        SecretStringTemplate: '{"username":"cloudops_admin"}'
        GenerateStringKey: "password"
        PasswordLength: 32
        ExcludePunctuation: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-db-secret"

  DbInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      Engine: postgres
      DBInstanceClass: !Ref DbInstanceClass
      AllocatedStorage: !Ref DbAllocatedStorage
      DBName: !Ref DbName
      StorageType: gp3
      StorageEncrypted: true
      PubliclyAccessible: false
      MultiAZ: false
      VPCSecurityGroups:
        - !Ref DbSecurityGroup
      DBSubnetGroupName: !Ref DbSubnetGroup
      MasterUsername: !Sub "{{resolve:secretsmanager:${DbSecret}:SecretString:username}}"
      MasterUserPassword: !Sub "{{resolve:secretsmanager:${DbSecret}:SecretString:password}}"
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
      DeletionProtection: false
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-db"

  ############################################################
  # Lambda (API) - VPC-attached with least privilege
  ############################################################
  ApiFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-ApiFunction"
      RetentionInDays: 7

  ApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-ApiFunction"
      CodeUri: .
      Handler: backend/api/app.handler
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
      Environment:
        Variables:
          DEMO_MODE: !Ref DemoMode
          MONITORED_API_GATEWAY_ID: !Ref MonitoredApiGatewayId
          DB_INSTANCE_ID: !Ref DbInstance
          DB_PORT: "5432"
          DB_NAME: !Ref DbName
          DB_SECRET_ARN: !Ref DbSecret
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSLambdaVPCAccessExecutionRole
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Ref DbSecret
            - Effect: Allow
              Action:
                - rds:DescribeDBInstances
              Resource: "*"
      Events:
        Health:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /health
            Method: GET
            Auth:
              Authorizer: NONE
      Tags:
        Name: !Sub "${AWS::StackName}-api-function"

  ############################################################
  # Cost Monitoring (Optional, us-east-1 only)
  ############################################################
  BillingAlarmTopic:
    Type: AWS::SNS::Topic
    Condition: CreateBillingAlarmInRegion
    Properties:
      TopicName: !Sub "${AWS::StackName}-billing-alarm"
      DisplayName: Billing Alarm Notifications
      Subscription:
        - Endpoint: !Ref AdminEmail
          Protocol: email

  BillingAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: CreateBillingAlarmInRegion
    Properties:
      AlarmName: !Sub "${AWS::StackName}-monthly-cost-alarm"
      AlarmDescription: !Sub "Alert when estimated monthly charges exceed $${BillingAlarmThreshold} (AWS/Billing metrics in us-east-1 only)"
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Dimensions:
        - Name: Currency
          Value: USD
      Statistic: Maximum
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !Ref BillingAlarmThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref BillingAlarmTopic

Outputs:
  AppUrl:
    Description: CloudFront URL (frontend)
    Value: !Sub "https://${CloudFrontDistribution.DomainName}"

  ApiBaseUrl:
    Description: API base URL
    Value: !Sub "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod"

  ApiHealthUrl:
    Description: API health endpoint (public, no auth)
    Value: !Sub "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/health"

  CognitoHostedUiLoginUrl:
    Description: Cognito Hosted UI login URL
    Value: !Sub
      - "https://${Domain}.auth.${AWS::Region}.amazoncognito.com/login?client_id=${ClientId}&response_type=code&scope=openid+email+profile&redirect_uri=${RedirectUri}"
      - Domain: !Ref UserPoolDomain
        ClientId: !Ref UserPoolClient
        RedirectUri: !Sub "https://${CloudFrontDistribution.DomainName}/callback"

  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool

  CognitoUserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient

  DbEndpoint:
    Description: RDS endpoint (hostname:port)
    Value: !Sub "${DbInstance.Endpoint.Address}:${DbInstance.Endpoint.Port}"

  DbSecretArn:
    Description: Secrets Manager ARN for DB credentials
    Value: !Ref DbSecret

  VpcId:
    Description: VPC ID
    Value: !Ref Vpc

  PrivateSubnetIds:
    Description: Private subnet IDs (comma-separated)
    Value: !Sub "${PrivateSubnetA},${PrivateSubnetB}"
